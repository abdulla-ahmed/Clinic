<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medical Session - Al-Kawaz Clinic</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    :root { --primary: #6698fd; --dark: #2c3e50; --border: #e0e0e0; }
    body { font-family: "Times New Roman", Times, serif; background: #fdfdfd; margin: 20px; color: var(--dark); }
    .container { max-width: 850px; margin: auto; background: white; padding: 30px; border: 1px solid var(--border); border-radius: 8px; }
    
    /* Search Section */
    .search-section { background: #eef4ff; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--primary); }
    input, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1em; }
    .search-date-label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }

    #reader { width: 100%; max-width: 400px; margin: 10px auto; border-radius: 8px; border: 2px solid var(--primary); display: none;}
    
    button { display: block; width: 100%; max-width: 450px; margin: 10px auto; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; }
    .btn-search { background-color: var(--primary); }
    .btn-scan { background-color: #4CAF50; }

    /* Results Table */
    .results-section { display: none; margin-top: 20px; width: 100%; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: var(--primary); color: white; }

    /* Patient Info - SMALL FONT ONE LINE */
    .patient-profile-column { display: flex; flex-direction: column; align-items: center; padding: 15px; background: #f0f4ff; border-radius: 12px; margin-bottom: 30px; border: 1px solid #ddecff; }
    .patient-photo { width: 130px; height: 150px; object-fit: cover; border: 4px solid white; border-radius: 8px; margin-bottom: 15px; }
    .info-list { width: 100%; max-width: 650px; font-size: 0.82em; } 
    .info-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(102, 152, 253, 0.2); width: 100%; }
    .info-label { font-weight: bold; color: #555; }

    /* Vitals Styling - Units Outside */
    .vitals-grid { display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
    .vital-item { display: flex; align-items: center; gap: 8px; }
    .v-box { width: 60px; height: 35px; border: 1px solid #ccc; border-radius: 6px; text-align: center; font-weight: normal; font-size: 1em; }
    .bp-box { width: 55px; } 

    /* Group Boxes */
    .group-box { padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid rgba(0,0,0,0.05); }
    .history-box { background-color: #fef9e7; border-left: 6px solid #f1c40f; }
    .vitals-box { background-color: #e8f8f5; border-left: 6px solid #1abc9c; }
    .exam-box { background-color: #f4f4f9; border-left: 6px solid #5d6d7e; }
    .inv-box { background-color: #fdf2f2; border-left: 6px solid #e74c3c; }
    .section-title { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; }

    /* File upload tags inside the box */
    #fileList { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .file-tag { background: white; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85em; }

    /* PREVIEW OVERLAY - Mirrored */
    #preview-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; overflow-y: auto; }
    .preview-content { background: white; width: 95%; max-width: 800px; margin: 20px auto; padding: 30px; border-radius: 12px; }
    .preview-section-title { background: #f0f4ff; padding: 6px 12px; font-weight: bold; color: var(--primary); margin: 20px 0 10px 0; border-left: 5px solid var(--primary); }
    .preview-data-box { background: #f9f9f9; border: 1px solid #eee; padding: 12px; font-size: 0.95em; white-space: pre-wrap; margin-bottom: 10px; }
    .attachment-indicator { color: #27ae60; font-weight: bold; margin-top: 10px; }

    #session-form { display: none; }
    .footer-btns { display: flex; gap: 10px; }
  </style>
</head>
<body>

<div class="container">
  <h1 style="text-align:center;">Medical Session</h1>

  <div class="search-section" id="search-block">
    <input type="text" id="searchInput" placeholder="Search Name, Reg. No., or Barcode">
    <label class="search-date-label">Filter by Date:</label>
    <input type="date" id="searchDate">
    <div id="reader"></div>
    <button type="button" class="btn-scan" onclick="startScanner()">Barcode Scanner</button>
    <button type="button" class="btn-search" onclick="searchPatient()">Search Patient</button>
    <div id="resultsArea" class="results-section">
      <table>
        <thead><tr><th>Name</th><th>Reg. No.</th><th>Entry Date</th></tr></thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
  </div>

  <div id="session-form">
    <h2 id="visitDisplay" style="text-align:center; color: var(--primary);"></h2>

    <div class="patient-profile-column">
      <img id="p_photo" class="patient-photo" src="" alt="Patient Photo">
      <div class="info-list" id="p_info_details"></div>
    </div>

    <div class="group-box vitals-box">
      <div class="section-title">Vital Signs</div>
      <div class="vitals-grid">
        <div class="vital-item"><label>Temp</label><input type="number" id="v_temp" class="v-box"> <span>CÂ°</span></div>
        <div class="vital-item"><label>HR</label><input type="number" id="v_hr" class="v-box"> <span>bpm</span></div>
        <div class="vital-item"><label>RR</label><input type="number" id="v_rr" class="v-box"> <span>bpm</span></div>
        <div class="vital-item">
            <label>BP</label>
            <input type="number" id="v_bp_s" class="v-box bp-box" placeholder="Sys"> <span style="color:#ccc">/</span> 
            <input type="number" id="v_bp_d" class="v-box bp-box" placeholder="Dia"> <span>mmHg</span>
        </div>
      </div>
    </div>

    <div class="group-box history-box">
      <div class="section-title">Clinical History</div>
      <label>Chief Complain</label><textarea id="h_chief" rows="2"></textarea>
      <label>Present Illness</label><textarea id="h_illness" rows="4"></textarea>
      <label>Review of Systems</label><textarea id="h_ros" rows="3"></textarea>
      <label>Past-Medical History</label><textarea id="h_past_med" rows="2"></textarea>
      <label>Past-Surgical History</label><textarea id="h_past_surg" rows="2"></textarea>
      <label>Drug History</label><textarea id="h_drugs" rows="2"></textarea>
      <label>Allergies</label><textarea id="h_allergies" rows="2"></textarea>
      <label>Blood Transfusion</label><textarea id="h_blood" rows="2"></textarea>
      <label>Family History</label><textarea id="h_family" rows="2"></textarea>
      <label>Social History</label><textarea id="h_social" rows="2"></textarea>
    </div>

    <div class="group-box exam-box">
      <div class="section-title">Physical Examination</div>
      <textarea id="exam_details" rows="6"></textarea>
    </div>

    <div class="group-box inv-box">
      <div class="section-title">Investigations</div>
      <textarea id="inv_notes" rows="4"></textarea>
      <button type="button" style="background:var(--primary); width:100%;" onclick="document.getElementById('fileInput').click()">Upload Files</button>
      <input type="file" id="fileInput" hidden multiple onchange="handleFiles(event)">
      <div id="fileList"></div>
    </div>

    <div class="footer-btns">
      <button style="background: var(--dark);" onclick="generatePreview()">Preview Session</button>
      <button style="background: #95a5a6;" onclick="location.reload()">Cancel</button>
    </div>
  </div>
</div>

<div id="preview-overlay">
  <div class="preview-content">
    <h2 style="text-align:center; color: var(--primary);">VISIT SUMMARY REPORT</h2>
    
    <div class="patient-profile-column">
      <img id="prev_p_photo" class="patient-photo" src="" alt="Photo">
      <div class="info-list" id="prev_info_details"></div>
    </div>

    <div class="preview-section-title">VITAL SIGNS</div>
    <div id="prev_vitals" class="preview-data-box"></div>

    <div class="preview-section-title">HISTORY & EXAMINATION</div>
    <div id="prev_history_content"></div>

    <div class="preview-section-title">INVESTIGATIONS</div>
    <div id="prev_inv_content" class="preview-data-box"></div>
    <div id="prev_attachment_mark" class="attachment-indicator"></div>

    <div class="footer-btns" style="margin-top:20px;">
      <button style="background: #f39c12;" onclick="document.getElementById('preview-overlay').style.display='none'">Return & Edit</button>
      <button style="background: #27ae60;" onclick="saveFinal()">Save & Finish</button>
    </div>
  </div>
</div>

<script>
  let allPatients = JSON.parse(localStorage.getItem('patients')) || [];
  let selectedPatient = null;
  let attachments = [];

  function searchPatient() {
    const text = document.getElementById('searchInput').value.toLowerCase();
    const dateQuery = document.getElementById('searchDate').value;
    const matches = allPatients.filter(p => {
        const nameMatch = p.name.toLowerCase().includes(text) || p.regNumber.includes(text);
        const dateMatch = dateQuery ? p.entryTime.includes(dateQuery) : true;
        return nameMatch && dateMatch;
    });
    const body = document.getElementById('resultsBody');
    body.innerHTML = "";
    if (matches.length > 0) {
      document.getElementById('resultsArea').style.display = "block";
      matches.forEach(p => {
        body.innerHTML += `<tr onclick='loadForm(${JSON.stringify(p)})'><td>${p.name}</td><td>${p.regNumber}</td><td>${p.entryTime ? p.entryTime.split('T')[0] : '--'}</td></tr>`;
      });
    } else { alert("Not found"); }
  }

  function startScanner() {
    const html5QrCode = new Html5Qrcode("reader");
    document.getElementById('reader').style.display = 'block';
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
        document.getElementById('searchInput').value = text;
        html5QrCode.stop().then(() => { document.getElementById('reader').style.display = 'none'; searchPatient(); });
    });
  }

  function loadForm(p) {
    selectedPatient = p;
    document.getElementById('search-block').style.display = 'none';
    document.getElementById('session-form').style.display = 'block';
    document.getElementById('p_photo').src = p.photo || '';
    
    const fields = [
      { l: "Name:", v: p.name }, { l: "Reg. No.:", v: p.regNumber },
      { l: "Age:", v: p.age }, { l: "Sex:", v: p.sex },
      { l: "Bl. gr. & Rh:", v: p.bloodGroup }, { l: "Kin Add.:", v: p.kinAddress },
      { l: "Kin Phone:", v: p.kinPhone }
    ];
    document.getElementById('p_info_details').innerHTML = fields.map(f => `<div class="info-row"><span class="info-label">${f.l}</span><span>${f.v}</span></div>`).join('');
  }

  function handleFiles(event) {
    const list = document.getElementById('fileList');
    for (let file of event.target.files) {
        attachments.push(file.name);
        const tag = document.createElement('div');
        tag.className = "file-tag";
        tag.innerText = "ðŸ“„ " + file.name;
        list.appendChild(tag);
    }
  }

  function generatePreview() {
    const p = selectedPatient;
    document.getElementById('prev_p_photo').src = p.photo || '';
    
    // Identity Mirror
    const fields = [
      { l: "Name:", v: p.name }, { l: "Reg. No.:", v: p.regNumber },
      { l: "Age/Sex:", v: p.age + "/" + p.sex }, { l: "Bl. gr. & Rh:", v: p.bloodGroup },
      { l: "Kin Phone:", v: p.kinPhone }
    ];
    document.getElementById('prev_info_details').innerHTML = fields.map(f => `<div class="info-row"><span class="info-label">${f.l}</span><span>${f.v}</span></div>`).join('');

    // Vitals Mirror
    document.getElementById('prev_vitals').innerText = `T: ${document.getElementById('v_temp').value}Â°C | HR: ${document.getElementById('v_hr').value} | RR: ${document.getElementById('v_rr').value} | BP: ${document.getElementById('v_bp_s').value}/${document.getElementById('v_bp_d').value} mmHg`;

    // Detailed History Mirror
    const historyData = [
      { l: "Chief Complain", id: "h_chief" }, { l: "Present Illness", id: "h_illness" },
      { l: "Review of Systems", id: "h_ros" }, { l: "Past-Medical", id: "h_past_med" },
      { l: "Past-Surgical", id: "h_past_surg" }, { l: "Drug History", id: "h_drugs" },
      { l: "Examination", id: "exam_details" }
    ];
    let histHtml = "";
    historyData.forEach(h => {
        const val = document.getElementById(h.id).value;
        if(val) histHtml += `<div style="font-weight:bold; font-size:0.9em; margin-top:5px;">${h.l}:</div><div class="preview-data-box">${val}</div>`;
    });
    document.getElementById('prev_history_content').innerHTML = histHtml;

    // Investigations Mirror
    document.getElementById('prev_inv_content').innerText = document.getElementById('inv_notes').value || "No clinical notes.";
    document.getElementById('prev_attachment_mark').innerText = attachments.length > 0 ? "ðŸ“Ž Files Attached: " + attachments.length : "";

    document.getElementById('preview-overlay').style.display = 'block';
  }

  function saveFinal() {
    alert("Session Saved!");
    location.href = 'mainpage.html';
  }
</script>
</body>
</html>
