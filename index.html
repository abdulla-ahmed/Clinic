<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login - Dr. Hayder Al-Kawaz Clinic App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0d6efd">
  <style>
    /* ========== ORIGINAL STYLES PRESERVED ========== */
    body { font-family: "Times New Roman", Times, serif; background-color: #f9f9f9; margin: 20px; }
    .container { max-width: 600px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
    h1, h2 { text-align: center; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, button { display: block; width: 100%; max-width: 400px; margin: 10px auto; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1em; }
    button { background-color: #28a745; color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
    button:hover { background-color: #218838; border-radius: 12px; }
    .error { color: red; text-align: center; margin-top: -5px; font-size: 0.9em; }
    .link { text-align: center; margin-top: 10px; }
    .link a { cursor: pointer; color: #007bff; text-decoration: none; }
    .link a:hover { text-decoration: underline; }
  </style>
</head>
<body>

<div class="container">
  <h1 style="color: white;background-color:#1e88e5; border-radius: 10px; ">Dr. Hayder Al-Kawaz Clinic </h1>

  <!-- LOGIN FORM -->
  <div id="loginForm">
    <h2>Login</h2>
    <form id="authLoginForm" onsubmit="event.preventDefault(); loginUser();">
      <label for="loginUsername">Username</label>
      <input type="text" id="loginUsername" name="username" autocomplete="username" placeholder="Enter your username" required>
      
      <label for="loginPassword">Password</label>
      <input type="password" id="loginPassword" name="password" autocomplete="current-password" placeholder="Enter your password" required>
      
      <button type="submit">Login</button>
    </form>
    <p class="error" id="loginError"></p>
    <div class="link">
      No account? <a onclick="toggleForm()">Register here</a>
    </div>
  </div>

  <!-- REGISTER FORM -->
  <div id="registerForm" style="display:none;">
    <h2>Register</h2>
    <form id="authRegisterForm" onsubmit="event.preventDefault(); registerUser();">
      <label>Name</label>
      <input type="text" id="regName" placeholder="Enter your name" required>
      
      <label>Username</label>
      <input type="text" id="regUsername" autocomplete="username" placeholder="Choose a username" required>
      
      <label>Email</label>
      <input type="email" id="regEmail" autocomplete="email" placeholder="Enter your email" required>
      
      <label>Password</label>
      <input type="password" id="regPassword" autocomplete="new-password" placeholder="Choose a password" required>
      
      <label>Confirm Password</label>
      <input type="password" id="regConfirm" autocomplete="new-password" placeholder="Confirm your password" required>
      
      <button type="submit">Register</button>
    </form>
    <p class="error" id="registerError"></p>
    <div class="link">
      Already have an account? <a onclick="toggleForm()">Login</a>
    </div>
  </div>
</div>

<script>
  // --- AUTH & AUTO-LOGIN LOGIC ---
  window.addEventListener('load', () => {
    if (document.getElementById("loginForm").style.display !== "none") {
      fetch('./check-session.php?t=' + Date.now())
        .then(res => { if (res.ok) window.location.href = "welcome.php"; })
        .catch(() => {});
    }
  });

  function forceLogout() {
    localStorage.clear();
    if (document.getElementById("loginForm").style.display !== "block") {
        window.location.href = "index.html?reason=expired";
    }
  }

  // Global Fetch Interceptor
  const { fetch: originalFetch } = window;
  window.fetch = async (...args) => {
    const response = await originalFetch(...args);
    const isLoginAttempt = args[0].includes('login.php') || args[0].includes('check-session.php');
    if ((response.status === 401 || response.status === 403) && !isLoginAttempt) {
      forceLogout();
    }
    return response;
  };

  document.addEventListener("visibilitychange", () => {
    const loginFormHidden = document.getElementById("loginForm").style.display === "none";
    if (document.visibilityState === "visible" && loginFormHidden) {
      fetch('./check-session.php?t=' + Date.now()).catch(() => {});
    }
  });

  // --- UI FUNCTIONS ---
  function toggleForm() {
    const loginF = document.getElementById("loginForm");
    const regF = document.getElementById("registerForm");
    loginF.style.display = (loginF.style.display === "none") ? "block" : "none";
    regF.style.display = (regF.style.display === "none") ? "block" : "none";
    clearErrors();
  }

  function clearErrors() {
    document.getElementById("loginError").textContent = "";
    document.getElementById("registerError").textContent = "";
  }

  function loginUser() {
    const user = document.getElementById("loginUsername").value;
    const pass = document.getElementById("loginPassword").value;

    fetch("./login.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: user, password: pass })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // ðŸ‘‡ Redirect based on admin flag
        if (data.is_admin == 1) {
            window.location.href = "admin.php"; // Admin goes to admin panel
        } else {
            window.location.href = "welcome.php"; // Normal user goes to welcome page
        }
      } else {
        document.getElementById("loginError").textContent = data.message;
      }
    })
    .catch(() => {
      document.getElementById("loginError").textContent = "Connection error.";
    });
  }

  function registerUser() {
    const pass = document.getElementById("regPassword").value;
    const confirm = document.getElementById("regConfirm").value;
    if (pass !== confirm) {
      document.getElementById("registerError").textContent = "Passwords do not match";
      return;
    }
    fetch("./register.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name: document.getElementById("regName").value,
        username: document.getElementById("regUsername").value,
        email: document.getElementById("regEmail").value,
        password: pass
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("Registration successful. Wait for admin approval.");
        toggleForm();
      } else {
        document.getElementById("registerError").textContent = data.message;
      }
    });
  }

  // Service Worker Registration
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js').then(reg => {
        console.log('v7 active');
      });
    });
  }
</script>
</body>
</html>
