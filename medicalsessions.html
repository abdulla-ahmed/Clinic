<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medical Session - Al-Kawaz Clinic</title>
  <style>
    :root { --primary: #6698fd; --secondary: #3376fe; --bg: #f4f7f6; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
    .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    
    /* Patient Header Card */
    .patient-card { display: flex; align-items: center; background: #eef4ff; padding: 15px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--primary); }
    .patient-card img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-right: 20px; border: 2px solid white; }
    .patient-info h2 { margin: 0; color: var(--secondary); }
    .visit-badge { margin-left: auto; background: var(--secondary); color: white; padding: 10px 20px; border-radius: 30px; font-weight: bold; }

    /* Forms */
    h3 { border-bottom: 2px solid var(--primary); padding-bottom: 5px; color: #444; margin-top: 30px; }
    .grid-vitals { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; background: #f9f9f9; padding: 15px; border-radius: 10px; }
    .vital-item { display: flex; flex-direction: column; }
    .vital-item label { font-size: 0.85em; font-weight: bold; margin-bottom: 5px; }
    .vital-input-wrap { display: flex; align-items: center; background: white; border: 1px solid #ccc; border-radius: 5px; padding: 2px 5px; }
    .vital-input-wrap input { border: none; width: 50px; padding: 8px; outline: none; text-align: center; }
    .bp-wrap { display: flex; align-items: center; }

    textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: inherit; resize: vertical; margin-bottom: 10px; }
    
    .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; color: white; }
    .btn-save { background: #4CAF50; width: 100%; margin-top: 20px; font-size: 1.1em; }
    .btn-upload { background: #ff9800; margin-bottom: 10px; }
    .btn-cancel { background: #9e9e9e; margin-top: 10px; width: 100%; }
    
    .investigation-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .file-preview { width: 100px; height: 100px; border: 1px solid #ddd; object-fit: cover; border-radius: 5px; }
    
    .search-section { background: #fff; padding: 20px; border-radius: 12px; border: 2px dashed var(--primary); margin-bottom: 20px; }
    #session-form { display: none; }
  </style>
</head>
<body>

<div class="container">
  <div id="search-area" class="search-section">
    <h2 style="text-align:center;">Find Patient for New Session</h2>
    <input type="text" id="searchInput" placeholder="Search Name or Reg No..." style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ccc;">
    <button class="btn" style="background:var(--primary); width:100%;" onclick="searchPatient()">Search Patient</button>
    <div id="resultsArea" style="margin-top:15px;"></div>
  </div>

  <div id="session-form">
    <div class="patient-card" id="patient-header">
      </div>

    <h3>Patient History</h3>
    <label>Chief Complain (*)</label>
    <textarea id="chiefComplain" rows="3" placeholder="50 words..."></textarea>
    
    <label>Present Illness (***)</label>
    <textarea id="presentIllness" rows="8" placeholder="150 words..."></textarea>
    
    <label>Review of Systems (**)</label>
    <textarea id="ros" rows="5" placeholder="100 words..."></textarea>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div><label>Past-Medical (*)</label><textarea id="pastMedical" rows="3"></textarea></div>
        <div><label>Past-Surgical (*)</label><textarea id="pastSurgical" rows="3"></textarea></div>
    </div>

    <label>Drug History (**)</label>
    <textarea id="drugHistory" rows="5"></textarea>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div><label>Allergies (*)</label><textarea id="allergies" rows="3"></textarea></div>
        <div><label>Blood Transfusion (*)</label><textarea id="bloodTransfusion" rows="3"></textarea></div>
    </div>

    <label>Family History (*)</label>
    <textarea id="familyHistory" rows="3"></textarea>
    
    <label>Social History (**)</label>
    <textarea id="socialHistory" rows="5"></textarea>

    <h3>Medical Examination</h3>
    <p><strong>Vital Signs</strong></p>
    <div class="grid-vitals">
      <div class="vital-item">
        <label>Temp</label>
        <div class="vital-input-wrap"><input type="number" id="v_temp"> <span>C°</span></div>
      </div>
      <div class="vital-item">
        <label>Heart Rate</label>
        <div class="vital-input-wrap"><input type="number" id="v_hr"> <span>bpm</span></div>
      </div>
      <div class="vital-item">
        <label>Resp. Rate</label>
        <div class="vital-input-wrap"><input type="number" id="v_rr"> <span>bpm</span></div>
      </div>
      <div class="vital-item">
        <label>Blood Pressure</label>
        <div class="bp-wrap">
            <div class="vital-input-wrap"><input type="number" id="v_bp_s"></div>
            <span style="padding:0 5px;">/</span>
            <div class="vital-input-wrap"><input type="number" id="v_bp_d"></div>
            <span style="font-size: 0.7em; margin-left:5px;">mmHg</span>
        </div>
      </div>
    </div>

    <h3>Examination</h3>
    <textarea id="physExamination" rows="10" placeholder="Examination Details (****)"></textarea>

    <h3>Investigations</h3>
    <label>Important Notes (***)</label>
    <textarea id="investigationNotes" rows="8"></textarea>
    
    <button type="button" class="btn btn-upload" onclick="document.getElementById('fileInput').click()">+ Upload Investigation (PDF/Image)</button>
    <input type="file" id="fileInput" hidden multiple accept="image/*,application/pdf" onchange="handleFileUploads(event)">
    <div class="investigation-list" id="filePreviewContainer"></div>

    <button class="btn btn-save" onclick="saveSession()">Save & Preview Session</button>
    <button class="btn btn-cancel" onclick="window.location.href='mainpage.html'">Cancel</button>
  </div>
</div>

<script>
  let allPatients = JSON.parse(localStorage.getItem('patients')) || [];
  let allSessions = JSON.parse(localStorage.getItem('sessions')) || [];
  let currentPatient = null;
  let investigationFiles = [];

  function searchPatient() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const results = allPatients.filter(p => p.name.toLowerCase().includes(query) || p.regNumber.includes(query));
    const container = document.getElementById('resultsArea');
    container.innerHTML = results.map(p => `
      <div onclick="selectPatient('${p.regNumber}')" style="padding:10px; background:#f0f0f0; margin-bottom:5px; border-radius:5px; cursor:pointer;">
        ${p.name} (${p.regNumber})
      </div>
    `).join('');
  }

  function selectPatient(regNum) {
    currentPatient = allPatients.find(p => p.regNumber === regNum);
    document.getElementById('search-area').style.display = 'none';
    document.getElementById('session-form').style.display = 'block';
    
    // Calculate Visit Number
    const previousVisits = allSessions.filter(s => s.regNumber === regNum).length;
    const currentVisitNo = previousVisits + 1;

    document.getElementById('patient-header').innerHTML = `
      <img src="${currentPatient.photo || 'https://via.placeholder.com/80'}" alt="Photo">
      <div class="patient-info">
        <h2>${currentPatient.name}</h2>
        <small>Reg: ${currentPatient.regNumber} | Age: ${currentPatient.age}</small>
      </div>
      <div class="visit-badge">Visit No. ${currentVisitNo}</div>
    `;
    currentPatient.currentVisitNo = currentVisitNo;
  }

  function handleFileUploads(e) {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = (event) => {
        investigationFiles.push(event.target.result);
        const img = document.createElement('img');
        img.src = file.type === 'application/pdf' ? 'https://cdn-icons-png.flaticon.com/512/337/337946.png' : event.target.result;
        img.className = 'file-preview';
        document.getElementById('filePreviewContainer').appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  }

  function saveSession() {
    const sessionData = {
      regNumber: currentPatient.regNumber,
      visitNo: currentPatient.currentVisitNo,
      date: new Date().toLocaleDateString(),
      history: {
        chief: document.getElementById('chiefComplain').value,
        illness: document.getElementById('presentIllness').value,
        ros: document.getElementById('ros').value,
        pastMed: document.getElementById('pastMedical').value,
        pastSurg: document.getElementById('pastSurgical').value,
        drugs: document.getElementById('drugHistory').value,
        allergies: document.getElementById('allergies').value,
        blood: document.getElementById('bloodTransfusion').value,
        family: document.getElementById('familyHistory').value,
        social: document.getElementById('socialHistory').value
      },
      vitals: {
        temp: document.getElementById('v_temp').value + " C°",
        hr: document.getElementById('v_hr').value + " bpm",
        rr: document.getElementById('v_rr').value + " bpm",
        bp: document.getElementById('v_bp_s').value + "/" + document.getElementById('v_bp_d').value + " mmHg"
      },
      examination: document.getElementById('physExamination').value,
      notes: document.getElementById('investigationNotes').value,
      files: investigationFiles
    };

    allSessions.push(sessionData);
    localStorage.setItem('sessions', JSON.stringify(allSessions));
    
    alert("Session Saved Successfully!");
    // In a real app, you would redirect to a preview/print page here
    location.reload(); 
  }
</script>

</body>
</html>
