<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medical Session - Al-Kawaz Clinic</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    :root { --primary: #6698fd; --dark: #2c3e50; --border: #e0e0e0; --bg: #fdfdfd; }
    body { font-family: "Times New Roman", Times, serif; background: var(--bg); margin: 20px; color: var(--dark); }
    .container { max-width: 850px; margin: auto; background: white; padding: 40px; border: 1px solid var(--border); border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    
    /* Search Section */
    .search-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid var(--border); }
    input, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
    
    button { padding: 12px; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; transition: 0.2s; }
    .btn-search { background: var(--primary); color: white; width: 100%; }
    .btn-camera { background: #4CAF50; color: white; margin-top: 5px; }

    /* Professional Patient Profile Redesign */
    .patient-profile-box { display: flex; gap: 30px; padding: 20px; border-bottom: 2px solid var(--primary); margin-bottom: 30px; background: #fff; }
    .patient-photo { width: 120px; height: 140px; object-fit: cover; border: 1px solid var(--border); border-radius: 4px; }
    .patient-details { flex: 1; }
    .detail-row { display: flex; padding: 4px 0; border-bottom: 1px solid #f0f0f0; }
    .detail-label { width: 180px; font-weight: bold; color: #555; }
    .detail-value { flex: 1; color: #000; }
    
    /* Visit Number Heading */
    .visit-heading { font-size: 1.4em; color: var(--primary); font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid var(--primary); display: inline-block; }

    /* Section Headings */
    .section-title { font-size: 1.1em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: var(--dark); background: #f0f0f0; padding: 10px; margin: 30px 0 15px 0; border-radius: 4px; }
    
    label { font-weight: bold; margin-top: 15px; display: block; }

    /* Vital Signs Design (Saved as requested) */
    .vitals-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; background: #f4f7f6; padding: 20px; border-radius: 10px; border: 1px solid #e0e0e0; margin: 20px 0; }
    .vital-box { display: flex; align-items: center; background: white; border: 1px solid #ccc; padding: 5px 12px; border-radius: 6px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
    .vital-box input { border: none; width: 55px; margin: 0; padding: 5px; text-align: center; font-weight: bold; background: transparent; }
    .vital-box span { font-size: 0.9em; color: #666; font-style: italic; }

    /* Buttons */
    .footer-btns { margin-top: 40px; display: flex; gap: 15px; }
    .btn-save { background: #2c3e50; color: white; flex: 2; font-size: 1.1em; }
    .btn-cancel { background: #95a5a6; color: white; flex: 1; }

    #session-form { display: none; }
    #resultsArea { margin-top: 10px; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; background: white; }
    td, th { padding: 12px; border-bottom: 1px solid #eee; text-align: left; cursor: pointer; }
    tr:hover { background: #f0f7ff; }
  </style>
</head>
<body>

<div class="container">
  <h1 style="text-align:center; border-bottom: 1px solid #ddd; padding-bottom: 10px;">Clinical Session</h1>

  <div class="search-section" id="search-block">
    <input type="text" id="searchInput" placeholder="Search Patient Name or ID...">
    <div id="reader" style="display:none; margin: 10px 0; border: 2px solid var(--primary);"></div>
    <button class="btn-search" onclick="searchPatient()">Search Patient</button>
    <button class="btn-camera" onclick="startScanner()" style="width:100%;">Scan Barcode</button>
    <div id="resultsArea">
      <table id="resultsTable"></table>
    </div>
  </div>

  <div id="session-form">
    <div class="visit-heading" id="visitDisplay"></div>
    
    <div class="patient-profile-box">
      <img id="p_photo" class="patient-photo" src="" alt="Patient">
      <div class="patient-details">
        <div class="detail-row"><div class="detail-label">Full Name:</div><div id="p_name" class="detail-value"></div></div>
        <div class="detail-row"><div class="detail-label">Registration No:</div><div id="p_reg" class="detail-value"></div></div>
        <div class="detail-row"><div class="detail-label">Age / Sex:</div><div id="p_age_sex" class="detail-value"></div></div>
        <div class="detail-row"><div class="detail-label">Blood Group:</div><div id="p_blood" class="detail-value"></div></div>
        <div class="detail-row"><div class="detail-label">Phone:</div><div id="p_phone" class="detail-value"></div></div>
      </div>
    </div>

    <div class="section-title">Patient History</div>
    <label>Chief Complain</label>
    <textarea id="h_chief" rows="3"></textarea>
    
    <label>Present Illness</label>
    <textarea id="h_illness" rows="9"></textarea>
    
    <label>Review of Systems</label>
    <textarea id="h_ros" rows="6"></textarea>

    <label>Past-Medical History</label>
    <textarea id="h_past_med" rows="3"></textarea>

    <label>Past-Surgical History</label>
    <textarea id="h_past_surg" rows="3"></textarea>

    <label>Drug History</label>
    <textarea id="h_drugs" rows="6"></textarea>

    <label>Allergies</label>
    <textarea id="h_allergies" rows="3"></textarea>

    <label>Blood Transfusion</label>
    <textarea id="h_blood_trans" rows="3"></textarea>

    <label>Family History</label>
    <textarea id="h_family" rows="3"></textarea>
    
    <label>Social History</label>
    <textarea id="h_social" rows="6"></textarea>

    <div class="section-title">Medical Examination</div>
    <p style="text-align:center; font-weight:bold; color:#666;">Vital Signs</p>
    <div class="vitals-container">
      <div class="vital-box"><input type="number" id="v_temp"> <span>CÂ°</span></div>
      <div class="vital-box"><input type="number" id="v_hr"> <span>bpm</span></div>
      <div class="vital-box"><input type="number" id="v_rr"> <span>bpm</span></div>
      <div class="vital-box">
        <input type="number" id="v_bp_s" placeholder="Sys"> <span>/</span> 
        <input type="number" id="v_bp_d" placeholder="Dia"> <span>mmHg</span>
      </div>
    </div>

    <label>Examination Details</label>
    <textarea id="exam_details" rows="12"></textarea>

    <div class="section-title">Investigations</div>
    <label>Important Notes</label>
    <textarea id="inv_notes" rows="9"></textarea>
    
    <button type="button" class="btn-camera" onclick="document.getElementById('fileInput').click()">+ Upload Investigation Files</button>
    <input type="file" id="fileInput" hidden multiple accept="image/*,application/pdf" onchange="handleFiles(event)">
    <div id="fileList" style="display:flex; gap:10px; margin-top:10px;"></div>

    <div class="footer-btns">
      <button class="btn-save" onclick="saveSession()">Save & Preview Session</button>
      <button class="btn-cancel" onclick="location.href='mainpage.html'">Cancel</button>
    </div>
  </div>
</div>

<script>
  let allPatients = JSON.parse(localStorage.getItem('patients')) || [];
  let allSessions = JSON.parse(localStorage.getItem('sessions')) || [];
  let selectedPatient = null;
  let attachments = [];

  function searchPatient() {
    const query = document.getElementById('searchInput').value.toLowerCase().trim();
    const results = allPatients.filter(p => p.name.toLowerCase().includes(query) || p.regNumber.toLowerCase().includes(query));
    const table = document.getElementById('resultsTable');
    table.innerHTML = results.map(p => `<tr onclick='loadForm(${JSON.stringify(p)})'><td>${p.name}</td><td>${p.regNumber}</td></tr>`).join('');
  }

  function loadForm(p) {
    selectedPatient = p;
    document.getElementById('search-block').style.display = 'none';
    document.getElementById('session-form').style.display = 'block';

    const visitNo = allSessions.filter(s => s.regNumber === p.regNumber).length + 1;
    document.getElementById('visitDisplay').innerText = "Visit Number: " + visitNo;
    selectedPatient.currentVisit = visitNo;

    // Fill Header
    document.getElementById('p_photo').src = p.photo || '';
    document.getElementById('p_name').innerText = p.name;
    document.getElementById('p_reg').innerText = p.regNumber;
    document.getElementById('p_age_sex').innerText = (p.age || 'N/A') + " / " + (p.sex || 'N/A');
    document.getElementById('p_blood').innerText = p.bloodGroup || 'N/A';
    document.getElementById('p_phone').innerText = p.phone || 'N/A';
  }

  function handleFiles(e) {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = (ev) => {
        attachments.push(ev.target.result);
        const thumb = document.createElement('img');
        thumb.src = ev.target.result;
        thumb.style.width = "60px";
        document.getElementById('fileList').appendChild(thumb);
      };
      reader.readAsDataURL(file);
    });
  }

  function saveSession() {
    const sessionData = {
      patientId: selectedPatient.regNumber,
      visitNo: selectedPatient.currentVisit,
      timestamp: new Date().toLocaleString(),
      history: {
        chief: document.getElementById('h_chief').value,
        illness: document.getElementById('h_illness').value,
        ros: document.getElementById('h_ros').value,
        pastMed: document.getElementById('h_past_med').value,
        pastSurg: document.getElementById('h_past_surg').value,
        drugs: document.getElementById('h_drugs').value,
        allergies: document.getElementById('h_allergies').value,
        blood: document.getElementById('h_blood_trans').value,
        family: document.getElementById('h_family').value,
        social: document.getElementById('h_social').value
      },
      vitals: {
        temp: document.getElementById('v_temp').value,
        hr: document.getElementById('v_hr').value,
        rr: document.getElementById('v_rr').value,
        bp: document.getElementById('v_bp_s').value + "/" + document.getElementById('v_bp_d').value
      },
      exam: document.getElementById('exam_details').value,
      notes: document.getElementById('inv_notes').value,
      files: attachments
    };

    allSessions.push(sessionData);
    localStorage.setItem('sessions', JSON.stringify(allSessions));
    
    // Save "currentSession" to temporary storage for preview.html to read
    localStorage.setItem('tempPreview', JSON.stringify(sessionData));
    
    location.href = 'preview.html';
  }

  function startScanner() {
    const reader = new Html5Qrcode("reader");
    document.getElementById('reader').style.display = 'block';
    reader.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
      document.getElementById('searchInput').value = txt;
      reader.stop();
      document.getElementById('reader').style.display = 'none';
      searchPatient();
    });
  }
</script>
</body>
</html>
